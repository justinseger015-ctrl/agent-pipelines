# V3 System Reference

The V3 system uses structured context and status files. All pipelines use this format.

## Template Variables

### Primary Variables (V3)

| Variable | Description |
|----------|-------------|
| `${CTX}` | Path to `context.json` - full session metadata and inputs |
| `${STATUS}` | Path where agent writes `status.json` |
| `${PROGRESS}` | Path to progress file (accumulated context) |
| `${ITERATION}` | Current iteration number (1-based) |
| `${SESSION_NAME}` | Session identifier |
| `${CONTEXT}` | Optional context injection (from CLI/env/config) |
| `${OUTPUT}` | Path for direct output (if configured) |

### Legacy Variables (Deprecated, Still Work)

| Variable | Maps To |
|----------|---------|
| `${SESSION}` | `${SESSION_NAME}` |
| `${INDEX}` | `${ITERATION} - 1` (0-based) |
| `${PROGRESS_FILE}` | `${PROGRESS}` |

**Note:** `${INPUTS}` is deprecated. Use `context.json` inputs object instead.

## context.json Format

Generated by the engine, available at `${CTX}`:

```json
{
  "stage": {
    "name": "improve-plan",
    "iteration": 5
  },
  "session": {
    "name": "auth-refactor",
    "started_at": "2026-01-12T10:00:00Z"
  },
  "paths": {
    "progress": ".claude/pipeline-runs/auth-refactor/progress-auth-refactor.md",
    "status": ".claude/pipeline-runs/auth-refactor/iterations/005/status.json",
    "output": ".claude/pipeline-runs/auth-refactor/iterations/005/output.md"
  },
  "inputs": {
    "from_initial": ["docs/plans/auth.md"],
    "from_stage": {
      "plan": [".claude/pipeline-runs/auth-refactor/stage-00-plan/iterations/003/output.md"]
    },
    "from_parallel": {
      "claude": ["parallel-01-review/providers/claude/iterations/001/output.md"],
      "codex": ["parallel-01-review/providers/codex/iterations/001/output.md"]
    },
    "from_previous_iterations": [
      "iterations/001/output.md",
      "iterations/002/output.md"
    ]
  },
  "commands": {
    "test": "npm test",
    "lint": "npm run lint",
    "format": "npm run format",
    "types": "npm run typecheck"
  },
  "limits": {
    "max_iterations": 25,
    "consensus": 2
  },
  "history": [
    {"iteration": 1, "decision": "continue"},
    {"iteration": 2, "decision": "continue"}
  ]
}
```

### Input Types

| Field | Description |
|-------|-------------|
| `from_initial` | Files passed via `--input` CLI flag |
| `from_stage` | Outputs from named previous stages |
| `from_parallel` | Outputs from parallel block providers |
| `from_previous_iterations` | This stage's prior iteration outputs |

**Access in prompts:**
```bash
# Read initial inputs
jq -r '.inputs.from_initial[]' ${CTX} | xargs cat

# Read from named stage
jq -r '.inputs.from_stage.plan[]' ${CTX} | xargs cat

# Read from parallel providers
jq -r '.inputs.from_parallel.claude[]' ${CTX} | xargs cat

# Use commands passthrough
TEST_CMD=$(jq -r '.commands.test // "npm test"' ${CTX})
$TEST_CMD
```

## status.json Format

Agent writes this to `${STATUS}` at end of each iteration:

```json
{
  "decision": "continue | stop | error",
  "reason": "Why this decision was made",
  "summary": "What happened this iteration",
  "work": {
    "items_completed": ["beads-001", "beads-002"],
    "files_touched": ["src/auth.ts", "tests/auth.test.ts"]
  },
  "errors": []
}
```

### Decision Values

| Decision | Meaning |
|----------|---------|
| `continue` | More work to do, run another iteration |
| `stop` | Work complete, terminate the pipeline |
| `error` | Something went wrong, terminate with error |

### For Judgment Termination

When using `judgment` termination, the `decision` field is critical:
- Agent must independently assess if quality has plateaued
- Write `decision: stop` when genuinely satisfied
- Engine checks for N consecutive `stop` decisions (consensus)

## Stage Configuration (stage.yaml)

```yaml
name: stage-name
description: One-sentence description

termination:
  type: queue | judgment | fixed
  min_iterations: 2      # judgment only: start checking after this
  consensus: 2           # judgment only: consecutive stops needed
  iterations: 5          # fixed only: exact iteration count
  max: 25                # optional hard cap

check_before: true       # Check termination before first iteration
delay: 3                 # Seconds between iterations
provider: claude         # claude | codex (default: claude)
model: opus              # see provider table below
context: |               # Optional: injected into prompt as ${CONTEXT}
  Custom instructions for this stage instance
```

### Provider/Model Options

| Provider | Models | Best For |
|----------|--------|----------|
| **claude** | opus, sonnet, haiku | General coding, nuanced judgment |
| **codex** | gpt-5.2-codex, o3, o3-mini, o4-mini | Code generation, reasoning |

**Override at runtime:**
```bash
./scripts/run.sh {stage} {session} {max} --provider=codex --model=o3
CLAUDE_PIPELINE_PROVIDER=codex ./scripts/run.sh {stage} {session} {max}
```

## Pipeline Configuration

```yaml
name: pipeline-name
description: What the pipeline accomplishes

# Optional: commands passed to all stages
commands:
  test: "npm test"
  lint: "npm run lint"
  types: "npm run typecheck"

stages:
  - name: plan
    stage: improve-plan          # Directory in scripts/stages/
    termination:
      type: judgment
      consensus: 2
      max: 5
    inputs:
      from_initial: true         # Pass CLI --input files

  - name: implement
    stage: ralph
    termination:
      type: fixed
      iterations: 10
    inputs:
      from_stage: plan           # Receives outputs from "plan" stage
```

### Parallel Blocks

Run multiple providers concurrently:

```yaml
stages:
  - name: dual-review
    parallel:
      providers: [claude, codex]
      stages:
        - name: analyze
          stage: code-review
          termination:
            type: fixed
            iterations: 1

  - name: synthesize
    stage: elegance
    inputs:
      from_parallel: analyze     # Receives outputs from both providers
```

## Directory Structure

```
.claude/
├── pipeline-runs/
│   └── {session}/
│       ├── state.json              # Engine state (iteration, status)
│       ├── progress-{session}.md   # Accumulated context
│       ├── stage-00-{name}/        # First stage
│       │   └── iterations/
│       │       ├── 001/
│       │       │   ├── status.json
│       │       │   └── output.md
│       │       └── ...
│       ├── parallel-01-{name}/     # Parallel block
│       │   ├── manifest.json       # Aggregated outputs
│       │   ├── resume.json         # Crash recovery
│       │   └── providers/
│       │       ├── claude/
│       │       │   ├── progress.md
│       │       │   └── stage-00-{name}/iterations/...
│       │       └── codex/...
│       └── stage-02-{name}/        # Post-parallel stage
├── locks/
│   └── {session}.lock              # Prevents concurrent sessions
└── pipeline-specs/
    └── {name}.yaml                 # Confirmed architecture specs

scripts/
├── stages/
│   └── {stage}/
│       ├── stage.yaml              # Stage configuration
│       └── prompt.md               # Prompt template
└── pipelines/
    └── {name}.yaml                 # Pipeline configuration
```

## Execution Commands

```bash
# Single-stage (equivalent)
./scripts/run.sh {stage} {session} {max}
./scripts/run.sh loop {stage} {session} {max}

# Multi-stage pipeline
./scripts/run.sh pipeline {name}.yaml {session}

# With inputs/context
./scripts/run.sh {stage} {session} {max} --input docs/plan.md
./scripts/run.sh {stage} {session} {max} --context "Focus on auth module"

# Validation
./scripts/run.sh lint loop {name}
./scripts/run.sh lint pipeline {name}.yaml

# Session management
./scripts/run.sh status {session}
./scripts/run.sh {stage} {session} {max} --resume
```
